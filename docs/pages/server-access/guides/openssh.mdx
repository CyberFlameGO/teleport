---
title: Using Teleport with OpenSSH
description: How to use Teleport on legacy systems with OpenSSH and sshd.
videoBanner: x0eYFUEIOrM
---

In this guide, we will show you how to configure the OpenSSH server `sshd` to
join a Teleport cluster. Existing fleets of OpenSSH servers can be configured to
accept SSH certificates dynamically issued by a Teleport CA.

Using Teleport and OpenSSH has the advantage of getting you up
and running, but in the long run, we would recommend replacing `sshd` with `teleport`.
We've outlined these reasons in [OpenSSH vs Teleport SSH for Servers?](https://gravitational.com/blog/openssh-vs-teleport/)

## Prerequisites

- A Linux host with the OpenSSH server `sshd` installed, but not Teleport.

- OpenSSH version 6.9 or above on your local machine. View your OpenSSH version
  with the command:
  
  ```code
  $ ssh -V
  ```

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

(!docs/pages/includes/tctl.mdx!)

## Step 1/4. Configure `sshd` to trust the Teleport CA

`sshd` must be told to allow users to log in with certificates generated by the
Teleport Auth Service. Start by exporting the Teleport CA public key.

<ScopedBlock scope="cloud">On your local machine,</ScopedBlock>
<ScopedBlock scope={["oss", "enterprise"]}>On your Auth Service host,</ScopedBlock>
print the Teleport certificate authority certificate to stdout:

```code
$ tctl auth export --type=user | sed "s/cert-authority\ //"
```

Copy the output. On the host where you are running `sshd`, run the following commands.

Assign the output of the `tctl auth export` command to an environment variable:

```code
$ export KEY="<pasted output>"
```

Make the public key accessible to `sshd`:

```code
$ sudo bash -c "echo \"$KEY\" > /etc/ssh/teleport_user_ca.pub"
$ sudo bash -c "echo 'TrustedUserCAKeys /etc/ssh/teleport_user_ca.pub' >> /etc/ssh/sshd_config"
```

Restart `sshd`. For systemd-enabled hosts, run the following command:

```code
$ sudo systemctl restart sshd
```

Now, `sshd` will trust users who present a Teleport-issued certificate.

## Step 2/4. Configure host authentication

Next, ask Teleport to issue valid host certificates for your `sshd` host. 

<ScopedBlock scope="cloud">

### Ensure that your user has the correct privileges

Your user must be authorized to read and write host certificates.

Create a file called `host-certifier.yaml` with the following content:

```yaml
kind: role
version: v5
metadata:
  name: host-certifier
spec:
  allow:
    rules:
      - resources:
          - host_cert
        verbs:
          - list
          - create
          - read
          - update
          - delete
```

Create the role resource:

```code
$ tctl create host-certifier.yaml
# role 'host-certifier' has been created
```

Fetch the configuration for your user. Replace `USERNAME` with the name of the
Teleport username that you used to log in to your cluster.

```code
$ tctl get user/USERNAME > myuser.yaml
```

Make the following change to `myuser.yaml`:

```diff
  roles:
   - access
   - auditor
   - editor
+  - host-certifier
```

Apply your change:

```code
$ tctl create -f myuser.yaml
```

Log out of your Teleport cluster and log in again.

You will now have the required permissions to export a host key for your `sshd`
host.


### Issue a host certificate

</ScopedBlock>

On <ScopedBlock scope="cloud">your local machine</ScopedBlock><ScopedBlock scope={["oss", "enterprise"]}>your Auth Service host</ScopedBlock>, assign the
IP address or fully qualified domain name of your Node to an environment
variable.

```code
$ ADDR=203.0.113.0
```

Run the following `tctl` command to generate a host certificate:

```code
$ tctl auth sign \
      --host=${ADDR?} \
      --format=openssh \
      --out=myhost

# The credentials have been written to myhost, myhost-cert.pub
```

The above command will result in a private key and certificate.

To generate certificates for multiple hosts, assign the `host` flag to a
comma-separated list of addresses. Certificates for wildcard domains are not
supported by OpenSSH, so each domain must be fully qualified.

Use `ssh-keygen` to verify the contents of the certificate:

```code
$ ssh-keygen -L -f myhost-cert.pub
```

The `Principals` section should contain the address you assigned to `ADDR`
earlier:

```
myhost-cert.pub:
        Type: ssh-rsa-cert-v01@openssh.com host certificate
        Public key: RSA-CERT SHA256:nHkp6SnrAW4AV00VUaqPgR6SgdyvV9MmjUrYnwZ779A
        Signing CA: RSA SHA256:euqx2Y8Pq+r0c94GKVNXAklBVTmAJtaQUn3/ehrfEJE (using rsa-sha2-512)
        Key ID: ""
        Serial: 0
        Valid: after 2022-04-22T11:14:16
        Principals: 
                203.0.113.0
        Critical Options: (none)
        Extensions: 
                x-teleport-authority UNKNOWN OPTION (len 33)
                x-teleport-role UNKNOWN OPTION (len 8)
```

Copy the host key and certificate to your `sshd` host, placing them in the
directory `/etc/ssh`.

Make sure these files have the correct permissions:

```code
$ sudo chmod 0600 /etc/ssh/myhost
$ sudo chmod 0600 /etc/ssh/myhost-cert.pub
```

Then add the following lines to `/etc/ssh/sshd_config` on your `sshd` host:

```yaml
HostKey /etc/ssh/myhost
HostCertificate /etc/ssh/myhost-cert.pub
```

Restart `sshd`.

## Step 3/4. Generate an SSH client configuration

The next step is to configure your OpenSSH client to connect to your `sshd` host
using credentials managed by Teleport.

First, make sure you are running OpenSSH's `ssh-agent` and have logged
in to your Teleport cluster:

<ScopedBlock scope={["oss","enterprise"]}>

```code
$ eval `ssh-agent`
$ tsh --proxy=root.example.com --user=myuser@example.com login
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

```code
$ eval `ssh-agent`
$ tsh --proxy=mytenant.teleport.sh --user=myuser@example.com login
```

</ScopedBlock>

The `ssh-agent` command prints additional commands to export the `SSH_AUTH_SOCK`
and `SSH_AGENT_PID` environment variables. These variables allow OpenSSH clients
to find the SSH agent. Running `ssh-agent` with `eval` executes these commands.

On your local machine, run the following `tsh` command. This will print a
configuration block that tells your SSH client to use credentials managed by
Teleport to connect to hosts in your cluster.

```code
$ tsh config > ssh_config_teleport
```

This command creates an SSH configuration file at a nonstandard location in
order to make it easier to clean up, but you can append the output of
`tsh config` to the default SSH config file (`~/.ssh/config`) if you wish.

If you are using Trusted Clusters, this will print an OpenSSH client
configuration block for the root cluster and all currently known leaf clusters.

<Details title="How does the config work?">

Teleport implements an SSH server that includes several **subsystems**, or
predefined commands that are run when the server handles a connection. The Proxy
Service implements a `proxy` subsystem that forwards SSH traffic to remote hosts
and Trusted Clusters.

Here is a brief explanation of the configuration that `tsh config` generates:

```
# Common flags for all {{ .ClusterName }} hosts
Host *.{{ .ClusterName }} {{ .ProxyHost }}
    UserKnownHostsFile "{{ .KnownHostsPath }}"
    IdentityFile "{{ .IdentityFilePath }}"
    CertificateFile "{{ .CertificateFilePath }}"
```

If the host you are `ssh`ing into belongs to your Teleport cluster (i.e., its
address is a subdomain of your cluster's domain), use a Teleport-managed known
hosts file, private key, and certificate that are stored in the `.tsh`
directory.

```
# Flags for all {{ .ClusterName }} hosts except the proxy
Host *.{{ .ClusterName }} !{{ .ProxyHost }}
    Port 3022
    ProxyCommand "{{ .TSHPath }}" proxy ssh --cluster={{ .ClusterName }} --proxy={{ .ProxyHost }} %r@%h:%p
```

If the host that you are `ssh`ing into belongs to your Teleport cluster, the
OpenSSH client will first execute a command, the `ProxyCommand`, that makes an
SSH connection to the Proxy Service. This command, `tsh proxy ssh`, requests the
`proxy` subsystem in order to forward SSH traffic through the Proxy Service to
your chosen host (including a host in a Trusted Cluster).

</Details>

<Details title="Using PowerShell on Windows?" opened={false}>

  If using PowerShell on Windows, note that normal shell redirection may write
  the file with the incorrect encoding. To ensure it's written properly, try the
  following:

  ```code
  $ tsh.exe config | out-file .ssh\config -encoding utf8 -append
  ```

</Details>

<Admonition
  type="tip"
  title="Multiple Clusters"
>

  If you switch between multiple Teleport Proxy Servers, you'll need to re-run
  `tsh config` for each to generate the cluster-specific configuration.

  Similarly, if Trusted Clusters are added or removed, be sure to re-run
  `tsh config` and replace the previous configuration.

</Admonition>

## Step 4/4. Connect to your `sshd` host

<ScopedBlock scope={["oss", "enterprise"]}>

Once you have appended the new text to your OpenSSH client configuration file,
you can log in to your `sshd` host using the configuration we generated earlier:

```code
$ ssh -F ssh_config_teleport user@${ADDR}.root.example.com
```

This will connect to the node `node1` on the `root.example.com` cluster. This
name does not need to be DNS accessible as the connection will be routed through
your Teleport Proxy Service.

If any Trusted Clusters exist, they are also configured:

```code
$ ssh -F ssh_config_teleport user@node2.leaf.example.com
```

When connecting to Nodes with Teleport daemons running on non-standard ports
(other than `3022`), a port may be specified:

```code
$ ssh -F ssh_config_teleport -p 4022 user@node3.leaf.example.com
```

</ScopedBlock>
<ScopedBlock scope={["cloud"]}>

Once you have appended the new text to your OpenSSH client configuration file,
you can log in to your `sshd` host using the configuration we generated earlier:

```code
$ ssh -F ssh_config_teleport user@${ADDR}.mytenant.teleport.sh
```

This will connect to the node `node1` on the `mytenant.teleport.sh` cluster. This
name does not need to be DNS accessible as the connection will be routed through
your Teleport Proxy Service.

If any Trusted Clusters exist, they are also configured:

```code
$ ssh -F ssh_config_teleport user@node2.mytenant.teleport.sh
```

When connecting to Nodes with Teleport daemons running on non-standard ports
(other than `3022`), a port may be specified:

```code
$ ssh -F ssh_config_teleport -p 4022 user@node3.mytenant.teleport.sh
```

</ScopedBlock>

<Admonition
  type="tip"
  title="Note"
>

  Teleport uses OpenSSH certificates instead of keys. When you connect to a
  remote host, OpenSSH verifies that the address of the host is listed under the
  `Principals` section of the OpenSSH certificate. Usually, this is a fully
  qualified domain name, rather than an IP address.

</Admonition>

## Revoke an SSH certificate

To revoke the current Teleport CA and generate a new one, run `tctl auth rotate`. Unless you've highly automated your
infrastructure, we would suggest you proceed with caution as this will invalidate the user
and host CAs, meaning that the new CAs will need to be exported to every OpenSSH-based machine again using `tctl auth export` as above.